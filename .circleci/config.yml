version: 2.1

commands:
  setup:
    description: "Installs python packages and source module"
    steps:
      - checkout
      - run:
          name: Setup Tools
          command: python3 -m pip install --upgrade pip setuptools wheel
      - run:
          name: Installing package
          command: pip3 install --upgrade -e .[dev] --user
  test:
    description: "Run tests, possibly publishing results"
    parameters:
      publish:
        type: boolean
        default: false
    steps:
      - run:
          name: pytest
          command: python3 -m pytest tests -s --doctest-modules --junitxml=junit/test-results.xml --cov=unmock --cov-report=xml --cov-report=html
      - when:
          condition: << parameters.publish >>
          steps:
            - store_test_results:
                path: junit

jobs:
  build:  # default entry point for CircleCI, test against Python 3.6.8
    docker:
      - image: circleci/python:3.6.8
    steps:
    - setup
    - test:
        publish: true
  
  macOS36:
    macos:
      # https://circle-macos-docs.s3.amazonaws.com/image-manifest/build-430/index.html
      # Python 3.6.5, Darwin 17.4.0, macOS 10.13.3
      xcode: "9.4.1"
    steps:
    - setup
    - test


  deploy:
    docker:
      - image: circleci/python:3.6.8
    steps:
    - setup
    - run: git config credential.helper "/bin/bash ./.circleci/git-credentials-helper.sh"
    - run: python setup.py upload

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
