version: 2.1

commands:
  setup:
    description: "Installs python packages and source module"
    steps:
      - checkout
      - run:
          name: Setup Tools
          command: python -m pip install --upgrade pip setuptools wheel
      - run:
          name: Installing package
          command: pip install --upgrade -e .[dev] --user
  test:
    description: "Run tests, possibly publishing results"
    parameters:
      publish:
        type: boolean
        default: false
    steps:
      - run:
          name: pytest
          command: python -m pytest tests -s --doctest-modules --junitxml=junit/test-results.xml --cov=unmock --cov-report=xml --cov-report=html
      - when:
          condition: << parameters.publish >>
          steps:
            - store_test_results:
                path: junit

jobs:
  build:  # default entry point for CircleCI
    docker:
      - image: circleci/python:3.6.8
    steps:
    - setup
    - test:
        publish: true

  deploy:
    docker:
      - image: circleci/python:3.6.8
    steps:
    - setup
    - run: git config credential.helper "/bin/bash ./.circleci/git-credentials-helper.sh"
    - run: python setup.py upload

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
