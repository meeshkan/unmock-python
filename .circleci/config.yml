version: 2
jobs:
  build:  # default entry point for CircleCI
    docker:
      - image: circleci/python:3.6.8
    steps:
    - checkout
    - run: python -m pip install --upgrade pip setuptools wheel
    - run: pip install --upgrade -e .[dev] --user
    - run: python -m pytest tests -s --doctest-modules --junitxml=junit/test-results.xml --cov=unmock --cov-report=xml --cov-report=html
    - store_test_results:
        path: junit/

  deploy:
    docker:
      - image: circleci/python:3.6.8
    steps:
    - checkout
    - build
    - run: git config credential.helper "/bin/bash ./.circleci/git-credentials-helper.sh"
    - run: python setup.py upload

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
